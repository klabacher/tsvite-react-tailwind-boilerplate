import { describe, it, expect, beforeEach } from 'vitest';
import { screen, waitFor } from '@testing-library/react';
import { renderApp, userEvent } from '../test/test-utils';
import { MemoryRouter, Routes, Route, Link, useLocation, useNavigate, useParams } from 'react-router-dom';

// Mock components for testing
function Home() {
  return <div data-testid="home">Home Page</div>;
}

function About() {
  return <div data-testid="about">About Page</div>;
}

function NotFound() {
  return <div data-testid="not-found">404 - Page Not Found</div>;
}

function UserProfile() {
  const { id } = useParams();
  return <div data-testid="user-profile">User Profile: {id}</div>;
}

function Navigation() {
  return (
    <nav>
      <Link to="/" data-testid="home-link">Home</Link>
      <Link to="/about" data-testid="about-link">About</Link>
    </nav>
  );
}

function TestApp() {
  return (
    <div>
      <Navigation />
      <Routes>
        <Route path="/" element={<Home />} />
        <Route path="/about" element={<About />} />
        <Route path="/user/:id" element={<UserProfile />} />
        <Route path="*" element={<NotFound />} />
      </Routes>
    </div>
  );
}

describe('React Router', () => {
  describe('Navigation', () => {
    it('should render home page by default', () => {
      renderApp(<TestApp />, { route: '/' });
      expect(screen.getByTestId('home')).toBeInTheDocument();
    });

    it('should navigate to about page', async () => {
      const user = userEvent.setup();
      renderApp(<TestApp />, { route: '/' });
      
      await user.click(screen.getByTestId('about-link'));
      await waitFor(() => {
        expect(screen.getByTestId('about')).toBeInTheDocument();
      });
    });

    it('should navigate back to home', async () => {
      const user = userEvent.setup();
      renderApp(<TestApp />, { route: '/about' });
      
      await user.click(screen.getByTestId('home-link'));
      await waitFor(() => {
        expect(screen.getByTestId('home')).toBeInTheDocument();
      });
    });
  });

  describe('Route Parameters', () => {
    it('should render user profile with id parameter', () => {
      renderApp(<TestApp />, { route: '/user/123' });
      expect(screen.getByTestId('user-profile')).toHaveTextContent('User Profile: 123');
    });

    it('should handle different user ids', () => {
      renderApp(<TestApp />, { route: '/user/abc' });
      expect(screen.getByTestId('user-profile')).toHaveTextContent('User Profile: abc');
    });
  });

  describe('404 Handling', () => {
    it('should render 404 for unknown routes', () => {
      renderApp(<TestApp />, { route: '/unknown' });
      expect(screen.getByTestId('not-found')).toBeInTheDocument();
    });

    it('should render 404 for deeply nested unknown routes', () => {
      renderApp(<TestApp />, { route: '/unknown/deep/path' });
      expect(screen.getByTestId('not-found')).toBeInTheDocument();
    });
  });

  describe('Hooks', () => {
    function LocationDisplay() {
      const location = useLocation();
      return <div data-testid="location">{location.pathname}</div>;
    }

    it('should access current location', () => {
      renderApp(<LocationDisplay />, { route: '/test-path' });
      expect(screen.getByTestId('location')).toHaveTextContent('/test-path');
    });

    function NavigateButton() {
      const navigate = useNavigate();
      return (
        <button onClick={() => navigate('/target')} data-testid="nav-button">
          Navigate
        </button>
      );
    }

    it('should programmatically navigate', async () => {
      const user = userEvent.setup();
      function TestNavApp() {
        const location = useLocation();
        return (
          <div>
            <NavigateButton />
            <div data-testid="current-path">{location.pathname}</div>
          </div>
        );
      }
      
      renderApp(<TestNavApp />, { route: '/' });
      await user.click(screen.getByTestId('nav-button'));
      
      await waitFor(() => {
        expect(screen.getByTestId('current-path')).toHaveTextContent('/target');
      });
    });
  });
});
