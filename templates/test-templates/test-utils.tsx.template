import React, { ReactElement, ReactNode } from 'react';
import { render, RenderOptions, RenderResult } from '@testing-library/react';
{{#if redux}}
import { Provider } from 'react-redux';
import { store } from '../store/store';
{{/if}}
{{#if reactRouter}}
import { MemoryRouter } from 'react-router-dom';
{{/if}}
{{#if i18n}}
import { I18nextProvider } from 'react-i18next';
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';

// Create a test i18n instance with mock translations
const testI18n = i18n.createInstance();
testI18n.use(initReactI18next).init({
  lng: 'en',
  fallbackLng: 'en',
  ns: ['translation'],
  defaultNS: 'translation',
  resources: {
    en: {
      translation: {
        welcome: 'Welcome',
        description: 'A modern React application',
        language: 'Language',
        counter: 'Counter',
        increment: 'Increment',
        decrement: 'Decrement',
        reset: 'Reset',
        features: 'Features',
        'features.redux': 'Redux Toolkit',
        'features.router': 'React Router',
        'features.tailwind': 'Tailwind CSS',
        'features.i18n': 'Internationalization',
      },
    },
  },
  interpolation: {
    escapeValue: false,
  },
});
{{/if}}

interface CustomRenderOptions extends Omit<RenderOptions, 'wrapper'> {
  route?: string;
{{#if i18n}}
  locale?: string;
{{/if}}
}

interface WrapperProps {
  children: ReactNode;
  route?: string;
{{#if i18n}}
  locale?: string;
{{/if}}
}

function AllProviders({ children, route = '/'{{#if i18n}}, locale = 'en'{{/if}} }: WrapperProps) {
{{#if i18n}}
  // Update locale if provided
  if (testI18n.language !== locale) {
    testI18n.changeLanguage(locale);
  }
{{/if}}

{{#if i18n}}
{{#if redux}}
{{#if reactRouter}}
  return (
    <I18nextProvider i18n={testI18n}>
      <Provider store={store}>
        <MemoryRouter initialEntries={[route]}>
          {children}
        </MemoryRouter>
      </Provider>
    </I18nextProvider>
  );
{{else}}
  return (
    <I18nextProvider i18n={testI18n}>
      <Provider store={store}>{children}</Provider>
    </I18nextProvider>
  );
{{/if}}
{{else}}
{{#if reactRouter}}
  return (
    <I18nextProvider i18n={testI18n}>
      <MemoryRouter initialEntries={[route]}>{children}</MemoryRouter>
    </I18nextProvider>
  );
{{else}}
  return <I18nextProvider i18n={testI18n}>{children}</I18nextProvider>;
{{/if}}
{{/if}}
{{else}}
{{#if redux}}
{{#if reactRouter}}
  return (
    <Provider store={store}>
      <MemoryRouter initialEntries={[route]}>
        {children}
      </MemoryRouter>
    </Provider>
  );
{{else}}
  return <Provider store={store}>{children}</Provider>;
{{/if}}
{{else}}
{{#if reactRouter}}
  return <MemoryRouter initialEntries={[route]}>{children}</MemoryRouter>;
{{else}}
  return <>{children}</>;
{{/if}}
{{/if}}
{{/if}}
}

export function renderApp(
  ui: ReactElement,
  options: CustomRenderOptions = {}
): RenderResult & { route: string{{#if i18n}}; locale: string{{/if}} } {
  const { route = '/'{{#if i18n}}, locale = 'en'{{/if}}, ...renderOptions } = options;

  const result = render(ui, {
    wrapper: ({ children }) => <AllProviders route={route}{{#if i18n}} locale={locale}{{/if}}>{children}</AllProviders>,
    ...renderOptions,
  });

  return {
    ...result,
    route,
{{#if i18n}}
    locale,
{{/if}}
    rerender: (newUi: ReactElement) =>
      result.rerender(<AllProviders route={route}{{#if i18n}} locale={locale}{{/if}}>{newUi}</AllProviders>),
  };
}

{{#if i18n}}
// Helper to change language during tests
export function changeTestLanguage(lang: string): Promise<void> {
  return testI18n.changeLanguage(lang) as Promise<void>;
}

// Export test i18n instance for advanced usage
export { testI18n };
{{/if}}

export * from '@testing-library/react';
export { default as userEvent } from '@testing-library/user-event';
